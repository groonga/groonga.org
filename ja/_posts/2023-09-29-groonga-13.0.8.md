---
layout: post.ja
title: Groonga 13.0.8リリース
description: Groonga 13.0.8をリリースしました！
published: false
---

## Groonga 13.0.8リリース

[Groonga 13.0.8](/ja/docs/news/13.html#release-13-0-8-2023-09-29)をリリースしました！

それぞれの環境毎のインストール方法: [インストール](/ja/docs/install.html)

### 変更内容

主な変更点は以下の通りです。

### 改良

* [[column_create](/ja/docs/reference/commands/column_create.html)] `column_create` に新しいフラグ `COLUMN_FILTER_SHUFFLE`, `COLUMN_FILTER_BYTE_DELTA`, `COMPRESS_FILTER_TRUNCATE_PRECISION_1BYTE`, `COMPRESS_FILTER_TRUNCATE_PRECISION_2BYTES` を追加しました。

  これらのフラグは、圧縮前にデータをフィルタリングすることによって `COMPRESS_ZLIB`, `COMPRESS_LZ4`, `COMPRESS_ZSTD` の圧縮率を高めるためのフラグです。 
  データによっては、これらのフラグを使っても圧縮率が上がらないこともあります。また、これらのフィルターを使うと、カラムの保存や参照に追加の処理が加わるので、これらのフィルターを使うと、カラムの保存や参照は確実に遅くなります。

  効果のあるフィルターのみを使う事が重要です。

  `COMPRESS_ZLIB`, `COMPRESS_LZ4`, `COMPRESS_ZSTD` を指定してない場合でも、これらのフィルターは、圧縮アルゴリズムとして [BloscLZ]( https://www.blosc.org/pages/blosc-in-depth/#blosc-as-a-meta-compressor ) を使うので、これらのフィルターを使うことで、ほとんどの場合で非圧縮のカラムよりもカラムサイズを小さくできます。
  ただ、データによっては、 `COMPRESS_ZLIB`, `COMPRESS_LZ4`, `COMPRESS_ZSTD` を使うだけで十分な場合もあります。
  そのため、データによって適切なフラグを設定することをおすすめします。

  これらのフラグは、 `COLUMN_VECTOR` でのみ使用できます。 `COLUMN_SCALAR` の場合は、これらのフラグは無視されます。

* 新しくBloscライブラリーを追加しました。

  `COLUMN_FILTER_SHUFFLE`, `COLUMN_FILTER_BYTE_DELTA`, `COMPRESS_FILTER_TRUNCATE_PRECISION_1BYTE`, `COMPRESS_FILTER_TRUNCATE_PRECISION_2BYTES` フラグがBloscを要求するためです。

* [[status](/ja/docs/reference/commands/status.html)] 新しく `status` の出力に `"blosc"` を追加しました。

* [[groonga](/ja/docs/reference/executables/groonga.html)] 新しく `groonga --version` の出力に `blosc` を追加しました。

* [[select](/ja/docs/reference/commands/select.html)] 新しく `select` の引数に `--fuzzy_max_distance` を追加しました。(実験的)

  この引数は、誤字を許容する検索を実行する時に有用です。ユーザーの誤字を自動で補正することができます。

  この引数が指定された場合、以下のようにマッチしないクエリーが与えられた時、Groongaは語彙表から `--fuzzy_max_distance` 以下の編集距離の語を探して、再度検索します。

  ```
  table_create Memos TABLE_NO_KEY
  column_create Memos content COLUMN_SCALAR ShortText

  table_create Lexicon TABLE_PAT_KEY ShortText   --default_tokenizer TokenNgram   --normalizer NormalizerNFKC150
  column_create Lexicon memos_content   COLUMN_INDEX|WITH_POSITION Memos content
  load --table Memos
  [
  {"content": "This is a pen"},
  {"content": "That is a pen"}
  ]

  select Memos   --match_columns content   --query "Thjs"   --fuzzy_max_distance 1   --output_columns *,_score
  [
    [
      0,
      0.0,
      0.0
    ],
    [
      [
        [
          1
        ],
        [
          [
            "content",
            "ShortText"
          ],
          [
            "_score",
            "Int32"
          ]
        ],
        [
          "This is a pen",
          1
        ]
      ]
    ]
  ]
  ```

* [[select](/ja/docs/reference/commands/select.html)] 新しく `select` の引数に `--fuzzy_max_expansions` を追加しました。(実験的)

  `--fuzzy_max_distance` を使うと、与えられたクエリーがマッチしない時、語彙表の中から `--fuzzy_max_distance` 以下の編集距離の語を使って再度検索します。

  例えば、語彙表に`This`と`That`が存在しているとします。
  `--fuzzy_max_distance 10`で`Thjs`というクエリーが与えられた時に、`Thjs`でマッチしない場合は、語彙表にある`This`と`That`で検索します。

  上記の例では、語彙表に `--fuzzy_max_distance` が10以下の語が2つしかありませんが、もし、編集距離が10以下の語が大量に語彙表に存在した場合、それらの語すべてを使って検索するため、パフォーマンスが落ちます。

  `--fuzzy_max_expansions` を使うことで検索に使う編集距離の近い語の数を制限できます。
  この引数を使って、ヒット数と検索パフォーマンスのバランスを取ることができます。

  `--fuzzy_max_expansions` のデフォルト値は0で、0の場合は語彙表にある編集距離が`--fuzzy_max_distance` 以下の語すべてを使って検索をします。

* [[select](/ja/docs/reference/commands/select.html)] 新しく `select` の引数に `--fuzzy_max_distance_ratio` を追加しました。.(実験的)

  `--fuzzy_max_distance` はすべてのクエリーに対して同じ値が設定されます。したがって、例えば "abc OR defghijklmn" というクエリーが与えられたときは "abc" と "defghijklmn" の両方に `--fuzzy_max_distance` の値が設定されます。

  しかし、検索するキーワードによって、誤字をどのくらい許容するかは異なっていることが多いです。
  例えば、"abc"は文字数が少ないので、誤字は1文字だけ許容する一方、"defghijklmn"は文字数が多いので、誤字は3文字許容するというようなことが発生します。

  `--fuzzy_max_distance_ratio` は文字数によって、編集距離を自動で変更するためのものです。
  この引数によって、キーワード毎に異なる編集距離を設定できます。

  `--fuzzy_max_distance_ratio FUZZY_MAX_DISTANCE` とすると、編集距離は"文字数 * FUZZY_MAX_DISTANCE"(小数点以下は切り捨てされます)と計算されます。
  "FUZZY_MAX_DISTANCE" は 0.34 を推奨しています。
  これは、0.34にするとElasticsearchの　[`fuzziness=AUTO`](https://www.elastic.co/guide/en/elasticsearch/reference/current/common-options.html#fuzziness)とほぼ同じ値になるためです。

* [[select](/ja/docs/reference/commands/select.html)] 新しく `select` の引数に `--fuzzy_prefix_length` を追加しました。(実験的)

  `--fuzzy_max_distance`を使う検索を高速化するための引数です。

  検索キーワードの先頭から `--fuzzy_prefix_length` に設定した文字数分が共通のデータのみヒットするようになります。

  `--fuzzy_max_distance` が大きくなると、処理対象が増加し遅くなるため、最初に先頭N文字が共通な文字列にのみ処理対象を絞ることで高速に処理できることが多いです。

* [cast] 以下のように、 `"[0.0, 1.0, 1.1, ...]"` を `Float`/`Float32` のベクターカラムへのキャストできるようにしました。

  ```
  plugin_register functions/vector

  table_create Data TABLE_NO_KEY
  column_create Data numbers COLUMN_VECTOR Float32

  table_create Numbers TABLE_PAT_KEY Float32
  column_create Numbers data_numbers COLUMN_INDEX Data numbers

  load --table Data
  [
  {"numbers": "[0.1, 0.0, -0.2]"},
  {"numbers": "[-3, 2, -4294967296, 4294967296]"}
  ]

  dump   --dump_plugins no   --dump_schema no
  load --table Data
  [
  ["_id","numbers"],
  [1,[0.1,0.0,-0.2]],
  [2,[-3.0,2.0,-4.294967e+09,4.294967e+09]]
  ]

  column_create Numbers data_numbers COLUMN_INDEX Data numbers
  select Data --filter 'vector_size(numbers) == 3'
  [
    [
      0,
      0.0,
      0.0
    ],
    [
      [
        [
          1
        ],
        [
          [
            "_id",
            "UInt32"
          ],
          [
            "numbers",
            "Float32"
          ]
        ],
        [
          1,
          [
            0.1,
            0.0,
            -0.2
          ]
        ]
      ]
    ]
  ]
  ```

* [fuzzy_search] `max_expansion` オプションの名前を `max_expansions` に変更しました。

  `max_expansion` オプションは非推奨になりますが、後方互換性を維持するため引き続き使えます。

* masterブランチの名前をmainに変更しました。

* [RPM] CMakeを使ってビルドするようにしました。

* [Debian] Debian trixie をサポートしました。

### 修正

* [fuzzy_search] ヒットするはずのレコードがヒットしない問題を修正しました。

* [near-phrase-search] 以下のように最初のフレーズグループに何もヒットしない時にGroongaがクラッシュする問題を修正しました。

  ```
  table_create Entries TABLE_NO_KEY
  column_create Entries content COLUMN_SCALAR Text
  table_create Terms TABLE_PAT_KEY ShortText \
    --default_tokenizer TokenNgram \
    --normalizer NormalizerNFKC121
  column_create Terms entries_content COLUMN_INDEX|WITH_POSITION \
    Entries content
  load --table Entries
  [
    {"content": "x y z"}
  ]
  select Entries \
    --match_columns Terms.entries_content.content \
    --query '*NPP1"(NONEXISTENT) (z)"' \
    --output_columns '_score, content'
  ```
